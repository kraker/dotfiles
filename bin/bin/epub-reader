#! /bin/bash

function epub-reader() {
    if [[ ! -f $1 ]]
    then
        echo "usage: $FUNCNAME <epub file>"
        return 1
    fi

    IFS=$'\n';

    # read the table of contents and unzip each file in order
    for i in $(
        unzip -p $1 *toc.ncx |
        perl -nle 'print $2 if m/<content src=(.)(.*?)[#\1]/;'
    )
    do
        unzip -p $1 *$i
    done |

    # fix internal links
    perl -ple 's/href=(.)(.*?)([#\1])/href=\1\3/g' |

    # display
    # lynx -stdin
    w3m -T text/html
}
